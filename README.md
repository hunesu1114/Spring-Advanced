로그추적기, 쓰레드로컬, 템플릿 메서드 패턴과 콜백 패턴에 대해 공부한다.

### **[0522]**

- **ThreadLocal** 를 이용하여 **동시성 문제** 해결.

만약 두 사용자 userA, userB 가 거의 동시에 save요청을 보냈을 때, userA의 데이터를 userB의 데이터가 덮는 상황이 나타날 수 있다. 그렇게 되면 userA가 get요청 보냈을 때, userB의 정보를 받게 되는 오류가 발생하게 된다. 

이때, ThreadLocal을 사용하면 각 사용자는 ThreadLocal을 통하게 되어 각 Thread마다 별도의 저장소를 할당 받게 되어 데이터를 덮어씌우는 상황이 생기지 않는다.

- V4(**템플릿 메서드 패턴**)

'V4'는 단순히 템플릿 메서드 패턴을 적용해서 소스코드 몇줄을 줄인 것이 전부가 아니다. 로그를 남기는 부분에 단일 책임 원칙(SRP)을 지킨것이다. 변경 지점을 하나로 모아서 변경에 쉽게 대처할 수 있는 구조를 만든 것이다.

But! 자식 클래스 입장에서 부모 클래스 기능 사용하지 않는데 상속 받는것은 불필요한 의존관계이다. 그리고 템플릿 메서드 패턴은 벼상속 구조를 사용하기 때문에, 별도의 클래스나 익명 내부틀래스를 만들어야 하는 부분도 번거롭다. 이를 더 깔끔하게, 그리고 템플릿 메서드 패턴과 비슷한 역할을 하면서 상속의 단점을 제거할 수 있는 디자인 패턴이 바로 전략 패턴(Strategy Pattern)이다.

- **전략 패턴**

Context에 Strategy를 필드나 파라미터로 받아서 처리

- V5(**템플릿 콜백 패턴**)

스프링에서 'XxxTemplate' 나오면 이번 내용 떠올리면 됨 ContextV2랑 똑같음. 파라미터로 객체를 받을 때 그 객체를 callback이라고 부른다. 

+익명 내부 클래스나, 람다 이용해서 리팩토링 

+아직도 한계 : 아무리 최적화를 해도 결국 로그 추적기를 적용하기 위해서 원본 코드를 수정해야 한다는 점 

-> 원본 손대지 않고 로그 추적기 적용하기위해 프록시 사용할거임

